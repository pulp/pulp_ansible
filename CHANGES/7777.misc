Refactors sync workflow to by asyncio based. Also add many tests.
