Improved a migration that was prone to running out of memory.
